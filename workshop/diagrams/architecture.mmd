graph TB
    subgraph "Data Source Layer"
        SAP["SAP System<br/>(Simulated)"]
        SIM["IDoc Simulator<br/>Python Application"]
    end
    
    subgraph "Ingestion Layer"
        EH["Azure Event Hubs<br/>sap-idocs"]
        ES["Fabric Eventstream<br/>Real-time Processing"]
    end
    
    subgraph "Storage & Processing Layer"
        subgraph "Eventhouse - Real-Time Processing"
            BRONZE_EH["Bronze Layer<br/>Raw IDocs<br/>KQL Table"]
            SILVER_EH["Silver Layer<br/>Cleansed Data<br/>KQL Update Policies"]
        end
        
        subgraph "Lakehouse - Analytics Storage"
            BRONZE_LH["Bronze Mirror<br/>Delta Table"]
            SILVER_LH["Silver Mirror<br/>Delta Table"]
            GOLD["Gold Layer<br/>Materialized Lake Views<br/>Star Schema"]
        end
        
        WH["SQL Warehouse<br/>Analytics Engine"]
    end
    
    subgraph "Consumption Layer"
        GQL["GraphQL API<br/>Flexible Queries"]
        APIM["API Management<br/>Gateway & Security"]
        PBI["Power BI<br/>Dashboards"]
    end
    
    subgraph "Governance Layer"
        PV["Microsoft Purview<br/>Data Catalog & Quality"]
        RLS["OneLake Security<br/>Row-Level Security"]
    end
    
    subgraph "Consumers"
        WEBAPP["Web Applications"]
        PARTNERS["Partner Systems"]
        MOBILE["Mobile Apps"]
    end
    
    %% Data Flow
    SAP -->|IDoc Messages| SIM
    SIM -->|JSON/XML| EH
    EH -->|Stream| ES
    
    ES -->|Ingest| BRONZE_EH
    BRONZE_EH -->|KQL Update Policy| SILVER_EH
    
    BRONZE_EH -.->|Auto Mirror| BRONZE_LH
    SILVER_EH -.->|Auto Mirror| SILVER_LH
    
    SILVER_LH -->|Materialized View| GOLD
    GOLD --> WH
    
    BRONZE_EH --> PBI
    SILVER_EH --> PBI
    WH --> GQL
    GQL --> APIM
    
    APIM --> WEBAPP
    APIM --> PARTNERS
    APIM --> MOBILE
    
    %% Governance
    PV -.->|Catalog| BRONZE_EH
    PV -.->|Catalog| SILVER_EH
    PV -.->|Quality| WH
    RLS -.->|Security| WH
    RLS -.->|Security| GQL
    
    %% Styling
    classDef sourceStyle fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef ingestionStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef eventhouseStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef lakehouseStyle fill:#e8eaf6,stroke:#283593,stroke-width:2px
    classDef consumptionStyle fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef governanceStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef consumerStyle fill:#f1f8e9,stroke:#33691e,stroke-width:2px
    
    class SAP,SIM sourceStyle
    class EH,ES ingestionStyle
    class BRONZE_EH,SILVER_EH eventhouseStyle
    class BRONZE_LH,SILVER_LH,GOLD,WH lakehouseStyle
    class GQL,APIM,PBI consumptionStyle
    class PV,RLS governanceStyle
    class WEBAPP,PARTNERS,MOBILE consumerStyle
