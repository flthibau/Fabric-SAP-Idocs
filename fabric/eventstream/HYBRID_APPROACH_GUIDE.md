# Guide d'utilisation - Approche Hybride Eventstream

## Vue d'ensemble

Ce guide documente l'approche **hybride** pour automatiser la cr√©ation d'Eventstreams dans Microsoft Fabric, bas√©e sur nos d√©couvertes durant l'investigation API.

## üéØ D√©couvertes Critiques

### 1. Publication Requise pour Export Complet
**D√©couverte majeure:** Un Eventstream NON publi√© exporte des sources/destinations vides.

```powershell
# ‚ùå Eventstream NON publi√©
fab export "SAP-IDoc-Fabric.Workspace/SAPIdocIngest.Eventstream" -o configured
# ‚Üí sources: []
# ‚Üí destinations: []

# ‚úÖ Eventstream PUBLI√â
fab export "SAP-IDoc-Fabric.Workspace/SAPIdocIngest.Eventstream" -o configured-published
# ‚Üí sources: [{ type: "AzureEventHub", ... }]
# ‚Üí destinations: [{ type: "Eventhouse", ... }]
```

### 2. Data Connections - Ressource S√©par√©e
Les connexions Event Hub sont stock√©es comme objets **Data Connection** s√©par√©s:

```json
{
  "sources": [{
    "id": "6a3e8dce-50fe-422a-af1e-e1008a9944a7",
    "name": "AzureEventHub",
    "type": "AzureEventHub",
    "properties": {
      "dataConnectionId": "9816c9cd-d299-4b31-9f08-27cc8b55f5ee", // ‚Üê R√©f√©rence externe
      "consumerGroupName": "fabric-consumer"
    }
  }]
}
```

**Implication:** Impossible d'int√©grer les credentials Event Hub directement dans le JSON - ils doivent √™tre cr√©√©s s√©par√©ment.

### 3. API Data Connections Introuvable
Tentatives test√©es (toutes √©chou√©es avec 404):
- `/workspaces/{id}/dataconnections`
- `/workspaces/{id}/connections`
- `/dataconnections/{id}`
- Acc√®s direct par GUID

**Conclusion:** L'API Fabric pour Data Connections n'est pas document√©e ou pas encore expos√©e.

## üîÄ Approche Hybride - La Solution

### Philosophie
Automatiser **tout ce qui peut l'√™tre**, accepter **une √©tape manuelle** pour les Data Connections.

### √âtapes

#### 1Ô∏è‚É£ Pr√©requis: Cr√©er Data Connection Manuellement

**Une seule fois par workspace:**

```
Fabric Portal
  ‚Üí Workspace Settings
  ‚Üí Connections
  ‚Üí New connection
  ‚Üí Azure Event Hubs
  
  Namespace: eh-idoc-flt8076.servicebus.windows.net
  Event Hub: idoc-events
  Shared Access Key: (depuis CONNECTION_INFO.md)
```

**Copier le GUID de la connexion cr√©√©e** (visible dans l'URL ou les d√©tails)

#### 2Ô∏è‚É£ Automatiser la Cr√©ation de l'Eventstream

```powershell
cd fabric\eventstream
.\create-eventstream-hybrid.ps1 `
  -WorkspaceName "SAP-IDoc-Fabric" `
  -EventstreamName "SAPIdocIngest-Automated" `
  -EventHubNamespace "eh-idoc-flt8076.servicebus.windows.net" `
  -EventHubName "idoc-events" `
  -ConsumerGroup "fabric-consumer" `
  -EventhouseName "kqldbsapidoc_auto"

# Le script demande le Data Connection ID
# Entrez le GUID copi√© √† l'√©tape 1
```

#### 3Ô∏è‚É£ Publier dans le Portal

```
1. Ouvrir Eventstream dans Fabric Portal
2. Mode "Edit" ‚Üí Cliquer "Publish"
3. Mode "Live" ‚Üí Configure destination ‚Üí Cr√©er table KQL
```

## üìä Workflow Complet

```mermaid
graph TD
    A[1. Cr√©er Data Connection<br/>manuellement dans Portal] -->|Copier GUID| B
    B[2. Ex√©cuter script<br/>create-eventstream-hybrid.ps1] -->|Fournir GUID| C
    C[3. Script cr√©e Eventstream<br/>avec sources/destinations] --> D
    D[4. Publier dans Portal] --> E
    E[5. Configurer table KQL<br/>destination]
    
    style A fill:#ff9,stroke:#333,stroke-width:2px
    style B fill:#9f9,stroke:#333,stroke-width:2px
    style C fill:#9f9,stroke:#333,stroke-width:2px
    style D fill:#ff9,stroke:#333,stroke-width:2px
    style E fill:#ff9,stroke:#333,stroke-width:2px
```

## üõ†Ô∏è Script create-eventstream-hybrid.ps1

### Ce que le script fait automatiquement

‚úÖ **R√©cup√©ration des IDs:**
- Workspace ID
- Eventhouse ID

‚úÖ **G√©n√©ration de la d√©finition JSON:**
- Source AzureEventHub avec dataConnectionId r√©f√©renc√©
- Destination Eventhouse avec Direct Ingestion
- Stream connectant source ‚Üí destination
- GUIDs uniques pour chaque √©l√©ment

‚úÖ **Encodage Base64:**
- `eventstream.json` (d√©finition compl√®te)
- `eventstreamProperties.json` (r√©tention, throughput)
- `.platform` (m√©tadonn√©es)

‚úÖ **Appels API:**
- Cr√©ation Eventstream vide
- Mise √† jour avec d√©finition compl√®te via `updateDefinition`

### Ce que le script demande

‚ùì **Input utilisateur:**
- **Data Connection GUID** (cr√©√© manuellement au pr√©alable)

### Structure JSON g√©n√©r√©e

```json
{
  "sources": [{
    "id": "<auto-generated>",
    "name": "AzureEventHub",
    "type": "AzureEventHub",
    "properties": {
      "dataConnectionId": "<user-provided>",
      "consumerGroupName": "fabric-consumer",
      "inputSerialization": { "type": "Json" }
    }
  }],
  "destinations": [{
    "id": "<auto-generated>",
    "name": "Eventhouse",
    "type": "Eventhouse",
    "properties": {
      "dataIngestionMode": "DirectIngestion",
      "workspaceId": "<retrieved>",
      "itemId": "<retrieved>"
    }
  }],
  "streams": [{
    "id": "<auto-generated>",
    "name": "SAPIdocIngest-stream",
    "type": "DefaultStream",
    "inputNodes": [{ "name": "AzureEventHub" }]
  }],
  "compatibilityLevel": "1.1"
}
```

## üéì Avantages de l'Approche Hybride

| Aspect | Avantage |
|--------|----------|
| **Reproductibilit√©** | Script automatise 90% des √©tapes |
| **Documentation** | JSON captur√© = template r√©utilisable |
| **S√©curit√©** | Credentials Event Hub stock√©s dans Fabric Data Connection |
| **Flexibilit√©** | Une Data Connection peut servir plusieurs Eventstreams |
| **CI/CD** | Script int√©grable dans pipelines DevOps |

## üîÑ R√©utilisation Multi-Environnements

### Sc√©nario: D√©ployer DEV ‚Üí QA ‚Üí PROD

```powershell
# 1. Cr√©er Data Connections dans chaque workspace (une fois)
#    DEV: connection-dev-guid
#    QA:  connection-qa-guid  
#    PROD: connection-prod-guid

# 2. Ex√©cuter script pour chaque environnement
.\create-eventstream-hybrid.ps1 `
  -WorkspaceName "SAP-IDoc-DEV" `
  -EventstreamName "SAPIdocIngest" `
  -DataConnectionId "connection-dev-guid"

.\create-eventstream-hybrid.ps1 `
  -WorkspaceName "SAP-IDoc-QA" `
  -EventstreamName "SAPIdocIngest" `
  -DataConnectionId "connection-qa-guid"

.\create-eventstream-hybrid.ps1 `
  -WorkspaceName "SAP-IDoc-PROD" `
  -EventstreamName "SAPIdocIngest" `
  -DataConnectionId "connection-prod-guid"
```

## üìñ R√©f√©rences

### Fichiers associ√©s
- `create-eventstream-hybrid.ps1` - Script d'automatisation
- `JSON_SCHEMA_ANALYSIS.md` - Analyse du sch√©ma JSON
- `MANUAL_CONFIGURATION_GUIDE.md` - √âtapes manuelles d√©taill√©es
- `CONNECTION_INFO.md` - Credentials Event Hub
- `configured-published/SAPIdocIngest.Eventstream/eventstream.json` - Template captur√©

### Export d'un Eventstream existant

```powershell
# Exporter pour capturer le template
fab export "WorkspaceName.Workspace/EventstreamName.Eventstream" -o export-folder -f

# Le fichier JSON sera ici:
# export-folder/EventstreamName.Eventstream/eventstream.json
```

### API Fabric utilis√©e

```powershell
# Cr√©ation Eventstream
fab mkdir "Workspace.Workspace/EventstreamName.Eventstream"

# Mise √† jour d√©finition
fab api "workspaces/{id}/eventstreams/{id}/updateDefinition?updateMetadata=true" -X post -i payload.json
```

## ‚ö†Ô∏è Limitations connues

| Limitation | Workaround |
|------------|-----------|
| Data Connections API indisponible | Cr√©ation manuelle dans Portal |
| Publication requise manuellement | Workflow Portal n√©cessaire |
| Table KQL cr√©√©e manuellement | Configuration Live mode requise |

## üöÄ Prochaines √âtapes

Apr√®s ex√©cution du script:

1. **V√©rifier dans Fabric Portal:**
   - Eventstream visible avec source/destination
   
2. **Publier:**
   - Mode Edit ‚Üí Publish
   
3. **Configurer table:**
   - Mode Live ‚Üí Configure ‚Üí Create table `idoc_raw`
   
4. **Tester flux de donn√©es:**
   ```powershell
   cd simulator
   python main.py --count 10
   ```

5. **V√©rifier ingestion:**
   ```kql
   idoc_raw
   | count
   ```

## üìû Support

Questions ou probl√®mes:
- Consulter `MANUAL_CONFIGURATION_GUIDE.md` pour √©tapes d√©taill√©es
- V√©rifier `JSON_SCHEMA_ANALYSIS.md` pour structure JSON
- Credentials Event Hub dans `CONNECTION_INFO.md`
