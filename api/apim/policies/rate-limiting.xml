<!-- Rate Limiting Policy for 3PL Partner API -->
<!-- Apply at API or Product level -->

<policies>
    <inbound>
        <base />
        
        <!-- Get partner tier from variable (set by oauth-validation policy) -->
        <set-variable name="tier" value="@(context.Variables.GetValueOrDefault<string>("partner-tier", "standard"))" />
        
        <!-- Determine rate limits based on tier -->
        <choose>
            <!-- Free tier: 10 requests/minute, 1,000/day -->
            <when condition="@(context.Variables.GetValueOrDefault<string>("tier") == "free")">
                <rate-limit-by-key 
                    calls="10" 
                    renewal-period="60" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" 
                    increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
                
                <quota-by-key 
                    calls="1000" 
                    renewal-period="86400" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" />
                
                <set-variable name="rate-limit-max" value="10" />
            </when>
            
            <!-- Standard tier: 60 requests/minute, 10,000/day -->
            <when condition="@(context.Variables.GetValueOrDefault<string>("tier") == "standard")">
                <rate-limit-by-key 
                    calls="60" 
                    renewal-period="60" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" 
                    increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
                
                <quota-by-key 
                    calls="10000" 
                    renewal-period="86400" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" />
                
                <set-variable name="rate-limit-max" value="60" />
            </when>
            
            <!-- Premium tier: 300 requests/minute, 100,000/day -->
            <when condition="@(context.Variables.GetValueOrDefault<string>("tier") == "premium")">
                <rate-limit-by-key 
                    calls="300" 
                    renewal-period="60" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" 
                    increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
                
                <quota-by-key 
                    calls="100000" 
                    renewal-period="86400" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" />
                
                <set-variable name="rate-limit-max" value="300" />
            </when>
            
            <!-- Enterprise tier: No limits -->
            <when condition="@(context.Variables.GetValueOrDefault<string>("tier") == "enterprise")">
                <set-variable name="rate-limit-max" value="unlimited" />
            </when>
            
            <!-- Default: Standard tier -->
            <otherwise>
                <rate-limit-by-key 
                    calls="60" 
                    renewal-period="60" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" 
                    increment-condition="@(context.Response.StatusCode >= 200 && context.Response.StatusCode < 300)" />
                
                <quota-by-key 
                    calls="10000" 
                    renewal-period="86400" 
                    counter-key="@(context.Request.Headers.GetValueOrDefault("X-Partner-Id", "unknown"))" />
                
                <set-variable name="rate-limit-max" value="60" />
            </otherwise>
        </choose>
    </inbound>
    
    <backend>
        <base />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Add rate limit headers to response -->
        <set-header name="X-RateLimit-Limit" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("rate-limit-max", "60"))</value>
        </set-header>
        
        <set-header name="X-RateLimit-Tier" exists-action="override">
            <value>@(context.Variables.GetValueOrDefault<string>("tier", "standard"))</value>
        </set-header>
        
        <!-- Add request count info (approximate) -->
        <set-header name="X-RateLimit-Reset" exists-action="override">
            <value>@(DateTime.UtcNow.AddMinutes(1).ToString("o"))</value>
        </set-header>
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Custom error for rate limit exceeded -->
        <choose>
            <when condition="@(context.LastError.Source == "rate-limit-by-key" || context.LastError.Source == "quota-by-key")">
                <return-response>
                    <set-status code="429" reason="Too Many Requests" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-header name="Retry-After" exists-action="override">
                        <value>60</value>
                    </set-header>
                    <set-header name="X-RateLimit-Limit" exists-action="override">
                        <value>@(context.Variables.GetValueOrDefault<string>("rate-limit-max", "60"))</value>
                    </set-header>
                    <set-header name="X-RateLimit-Tier" exists-action="override">
                        <value>@(context.Variables.GetValueOrDefault<string>("tier", "standard"))</value>
                    </set-header>
                    <set-body>@{
                        var tier = context.Variables.GetValueOrDefault<string>("tier", "standard");
                        var limit = context.Variables.GetValueOrDefault<string>("rate-limit-max", "60");
                        
                        return JsonConvert.SerializeObject(new {
                            error = "rate_limit_exceeded",
                            message = $"Rate limit exceeded for {tier} tier. Limit: {limit} requests/minute.",
                            tier = tier,
                            limit = limit,
                            retry_after = 60,
                            upgrade_info = "Contact support to upgrade to a higher tier for more capacity."
                        });
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>
