<!-- Fabric Authentication Passthrough Policy for APIM -->
<!-- Transmet les requêtes à l'API GraphQL native de Fabric avec authentification Managed Identity -->

<policies>
    <inbound>
        <base />
        
        <!-- 1. Valider le JWT du partenaire (Azure AD B2C) -->
        <validate-jwt header-name="Authorization" failed-validation-httpcode="401">
            <openid-config url="https://login.microsoftonline.com/{{tenant-id}}/.well-known/openid-configuration" />
            <audiences>
                <audience>{{apim-client-id}}</audience>
            </audiences>
            <required-claims>
                <claim name="partner_id" match="any">
                    <value>CARRIER-FEDEX</value>
                    <value>WAREHOUSE-EAST</value>
                    <value>CUSTOMER-ACME</value>
                </claim>
                <claim name="scope">
                    <value>api.read</value>
                </claim>
            </required-claims>
        </validate-jwt>
        
        <!-- 2. Extraire le partner_id du JWT pour logging/monitoring -->
        <set-variable name="partner-id">
            <value>@{
                var jwt = context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", "").AsJwt();
                return jwt.Claims.GetValueOrDefault("partner_id", "");
            }</value>
        </set-variable>
        
        <!-- 3. Extraire le tier pour rate limiting -->
        <set-variable name="partner-tier">
            <value>@{
                var jwt = context.Request.Headers.GetValueOrDefault("Authorization", "").Replace("Bearer ", "").AsJwt();
                return jwt.Claims.GetValueOrDefault("tier", "standard");
            }</value>
        </set-variable>
        
        <!-- 4. Obtenir un token Fabric via Managed Identity de l'APIM -->
        <!-- Le Managed Identity de l'APIM doit avoir le rôle RLS approprié dans Fabric -->
        <authentication-managed-identity resource="https://analysis.windows.net/powerbi/api" output-token-variable-name="fabric-token" />
        
        <!-- 5. Remplacer l'Authorization header par le token Fabric -->
        <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["fabric-token"])</value>
        </set-header>
        
        <!-- 6. Ajouter le partner_id en header custom pour traçabilité côté Fabric -->
        <!-- Note: Le RLS sera appliqué via le Service Principal du Managed Identity -->
        <!-- Pour un RLS dynamique par partner, il faudrait mapper chaque partner à un Service Principal distinct -->
        <set-header name="X-Partner-Id" exists-action="override">
            <value>@((string)context.Variables["partner-id"])</value>
        </set-header>
        
        <!-- 7. Ajouter des headers de traçabilité -->
        <set-header name="X-Request-Id" exists-action="override">
            <value>@(Guid.NewGuid().ToString())</value>
        </set-header>
        
        <set-header name="X-Partner-Tier" exists-action="override">
            <value>@((string)context.Variables["partner-tier"])</value>
        </set-header>
        
        <!-- 8. Backend URL: API GraphQL de Fabric -->
        <set-backend-service base-url="https://api.fabric.microsoft.com/v1/workspaces/{{fabric-workspace-id}}/graphql" />
    </inbound>
    
    <backend>
        <!-- Timeout plus long pour les requêtes GraphQL complexes -->
        <forward-request timeout="60" />
    </backend>
    
    <outbound>
        <base />
        
        <!-- Ajouter des headers de réponse pour le partner -->
        <set-header name="X-Served-By" exists-action="override">
            <value>APIM-Fabric-GraphQL</value>
        </set-header>
        
        <set-header name="X-Partner-Context" exists-action="override">
            <value>@{
                return JsonConvert.SerializeObject(new {
                    partner_id = context.Variables.GetValueOrDefault<string>("partner-id", ""),
                    tier = context.Variables.GetValueOrDefault<string>("partner-tier", "standard"),
                    request_id = context.Request.Headers.GetValueOrDefault("X-Request-Id", "")
                });
            }</value>
        </set-header>
        
        <!-- CORS configuration -->
        <cors allow-credentials="false">
            <allowed-origins>
                <origin>https://partner-portal.3pl-logistics.com</origin>
                <origin>http://localhost:3000</origin>
            </allowed-origins>
            <allowed-methods>
                <method>GET</method>
                <method>POST</method>
                <method>OPTIONS</method>
            </allowed-methods>
            <allowed-headers>
                <header>Content-Type</header>
                <header>Authorization</header>
                <header>X-Partner-Id</header>
            </allowed-headers>
            <expose-headers>
                <header>X-RateLimit-Limit</header>
                <header>X-RateLimit-Remaining</header>
                <header>X-Partner-Context</header>
                <header>X-Request-Id</header>
            </expose-headers>
        </cors>
        
        <!-- Cacher le token Fabric dans les erreurs -->
        <set-header name="WWW-Authenticate" exists-action="delete" />
    </outbound>
    
    <on-error>
        <base />
        
        <!-- Erreurs personnalisées pour meilleure UX partner -->
        <choose>
            <!-- Erreur d'authentification Fabric -->
            <when condition="@(context.LastError.Source == "authentication-managed-identity")">
                <return-response>
                    <set-status code="503" reason="Service Unavailable" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return JsonConvert.SerializeObject(new {
                            error = "fabric_unavailable",
                            message = "Unable to connect to Fabric API. Please try again later.",
                            request_id = context.Request.Headers.GetValueOrDefault("X-Request-Id", ""),
                            timestamp = DateTime.UtcNow.ToString("o")
                        });
                    }</set-body>
                </return-response>
            </when>
            
            <!-- Erreur de validation JWT partner -->
            <when condition="@(context.LastError.Source == "validate-jwt")">
                <return-response>
                    <set-status code="401" reason="Unauthorized" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return JsonConvert.SerializeObject(new {
                            error = "invalid_token",
                            message = "Invalid or expired access token. Please authenticate again.",
                            request_id = context.Request.Headers.GetValueOrDefault("X-Request-Id", ""),
                            timestamp = DateTime.UtcNow.ToString("o")
                        });
                    }</set-body>
                </return-response>
            </when>
            
            <!-- Timeout -->
            <when condition="@(context.LastError.Reason == "Timeout")">
                <return-response>
                    <set-status code="504" reason="Gateway Timeout" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return JsonConvert.SerializeObject(new {
                            error = "timeout",
                            message = "The request to Fabric API timed out. Please try again with a simpler query.",
                            request_id = context.Request.Headers.GetValueOrDefault("X-Request-Id", ""),
                            timestamp = DateTime.UtcNow.ToString("o")
                        });
                    }</set-body>
                </return-response>
            </when>
            
            <!-- Erreur générique -->
            <otherwise>
                <return-response>
                    <set-status code="500" reason="Internal Server Error" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return JsonConvert.SerializeObject(new {
                            error = "internal_error",
                            message = "An unexpected error occurred. Please contact support.",
                            request_id = context.Request.Headers.GetValueOrDefault("X-Request-Id", ""),
                            timestamp = DateTime.UtcNow.ToString("o"),
                            details = new {
                                source = context.LastError.Source,
                                reason = context.LastError.Reason
                            }
                        });
                    }</set-body>
                </return-response>
            </otherwise>
        </choose>
    </on-error>
</policies>

<!--
CONFIGURATION REQUISE DANS APIM:

1. Named Values à créer:
   - tenant-id: <votre-tenant-id>
   - apim-client-id: <client-id de l'APIM app registration>
   - fabric-workspace-id: ad53e547-23dc-46b0-ab5f-2acbaf0eec64

2. Managed Identity:
   - Activer System-assigned Managed Identity sur l'APIM
   - Ajouter ce Managed Identity aux rôles RLS dans Fabric
   
3. Rôles RLS à configurer dans Fabric pour le Managed Identity:
   - Option A: Un seul rôle "ALL_PARTNERS" avec accès complet (simplifié)
   - Option B: Logique dynamique basée sur X-Partner-Id (avancé)

4. Alternative pour RLS par partner:
   - Créer 3 Service Principals distincts (un par partner)
   - Dans la policy, utiliser authentication-certificate avec le certificat du partner
   - Mapper certificat → Service Principal → Rôle RLS Fabric
   
EXEMPLE DE REQUETE GRAPHQL QUI SERA ENVOYEE A FABRIC:

POST https://api.fabric.microsoft.com/v1/workspaces/ad53e547-23dc-46b0-ab5f-2acbaf0eec64/graphql
Authorization: Bearer <fabric-managed-identity-token>
X-Partner-Id: CARRIER-FEDEX
X-Request-Id: 123e4567-e89b-12d3-a456-426614174000

{
  "query": "{ idoc_shipments_gold(filter: { status: { eq: \"IN_TRANSIT\" } }, first: 10) { shipment_number carrier_id customer_name status } }"
}

Le RLS dans Fabric filtrera automatiquement selon le Service Principal (Managed Identity).
-->
